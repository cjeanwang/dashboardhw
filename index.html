<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Performance Dashboard</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load D3.js -->
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        /* Custom styles for D3 charts */
        .axis-label {
            font-size: 0.8rem;
            fill: #4b5563; /* text-gray-600 */
        }
        .axis path,
        .axis line {
            fill: none;
            stroke: #d1d5db; /* text-gray-300 */
            shape-rendering: crispEdges;
        }
        .grid line {
            stroke: #e5e7eb; /* text-gray-200 */
            stroke-opacity: 0.7;
            shape-rendering: crispEdges;
        }
        .tooltip {
            position: absolute;
            text-align: center;
            padding: 8px;
            font: 12px sans-serif;
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        /* Chat styles */
        .chat-message.user {
            text-align: right;
        }
        .chat-message.user p {
            background-color: #4f46e5; /* indigo-600 */
            color: white;
        }
        .chat-message.bot p {
            background-color: #e5e7eb; /* gray-200 */
            color: #1f2937; /* gray-800 */
        }
        .chat-message p {
            padding: 0.75rem;
            border-radius: 0.75rem;
            display: inline-block;
            max-width: 90%;
            text-align: left;
            word-wrap: break-word;
        }
        #chat-messages {
            scroll-behavior: smooth;
        }
    </style>
</head>
<body class="font-inter bg-gray-50 text-gray-800">

    <!-- Main Container -->
    <div class="flex flex-col lg:flex-row min-h-screen">

        <!-- Sidebar: Filters -->
        <aside class="w-full lg:w-1/4 xl:w-1/5 p-6 bg-white border-r border-gray-200 shadow-lg lg:shadow-none">
            <h2 class="text-2xl font-bold text-indigo-600 mb-6">Filters</h2>

            <!-- Filter Sections -->
            <div id="filters-container" class="space-y-6">
                <!-- Filters will be dynamically inserted here -->
            </div>
        </aside>

        <!-- Main Content: Dashboard -->
        <main class="flex-1 p-6 lg:p-10">
            <h1 class="text-4xl font-bold text-gray-900 mb-8">Student Performance Dashboard</h1>

            <!-- KPIs: Average Scores -->
            <section id="kpis" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Avg. Math Score</h3>
                    <p id="avg-math" class="text-4xl font-semibold text-indigo-600 mt-2">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Avg. Reading Score</h3>
                    <p id="avg-reading" class="text-4xl font-semibold text-green-600 mt-2">0</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-sm font-medium text-gray-500 uppercase tracking-wider">Avg. Writing Score</h3>
                    <p id="avg-writing" class="text-4xl font-semibold text-pink-600 mt-2">0</p>
                </div>
            </section>

            <!-- Charts -->
            <section class="grid grid-cols-1 xl:grid-cols-2 gap-8 mb-8">
                
                <!-- Chart 1: Score Distribution (Histogram) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-semibold">Score Distribution</h3>
                        <select id="histogram-score" class="rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            <option value="math score">Math</option>
                            <option value="reading score">Reading</option>
                            <option value="writing score">Writing</option>
                        </select>
                    </div>
                    <div id="histogram-chart" class="w-full h-80"></div>
                </div>

                <!-- Chart 2: Score Correlation (Scatter Plot) -->
                <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                    <h3 class="text-xl font-semibold mb-4">Score Correlation</h3>
                    <div class="flex justify-between items-center mb-4 gap-4">
                        <div class="flex-1">
                            <label for="scatter-x" class="block text-sm font-medium text-gray-700">X-Axis</label>
                            <select id="scatter-x" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="math score">Math</option>
                                <option value="reading score" selected>Reading</option>
                                <option value="writing score">Writing</option>
                            </select>
                        </div>
                        <div class="flex-1">
                            <label for="scatter-y" class="block text-sm font-medium text-gray-700">Y-Axis</label>
                            <select id="scatter-y" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                                <option value="math score">Math</option>
                                <option value="reading score">Reading</option>
                                <option value="writing score" selected>Writing</option>
                            </select>
                        </div>
                    </div>
                    <div id="scatter-plot" class="w-full h-80"></div>
                </div>

            </section>
            
            <!-- Data Table -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h3 class="text-xl font-semibold mb-4">Filtered Student Data</h3>
                <p class="text-sm text-gray-600 mb-4">
                    Showing <span id="table-count">0</span> matching students.
                </p>
                <div class="overflow-x-auto max-h-96">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50 sticky top-0">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gender</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Race/Ethnicity</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Parental Education</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lunch</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Test Prep</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Math</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Reading</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Writing</th>
                            </tr>
                        </thead>
                        <tbody id="data-table" class="bg-white divide-y divide-gray-200">
                            <!-- Data rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </section>
        </main>
    </div>

    <!-- Tooltip -->
    <div id="tooltip" class="tooltip"></div>

    <!-- Chat Widget -->
    <div id="chat-widget" class="hidden fixed bottom-24 right-6 w-96 max-w-[90%] bg-white rounded-xl shadow-2xl border border-gray-200 flex-col z-50" style="height: 60vh;">
        <!-- Chat Header -->
        <div class="flex justify-between items-center p-4 bg-indigo-600 text-white rounded-t-xl">
            <h3 class="text-lg font-semibold">Data Assistant</h3>
            <button id="close-chat" class="text-white hover:text-gray-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>
        </div>
        
        <!-- Chat Messages -->
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-3">
            <!-- Initial bot message -->
            <div class="chat-message bot">
                <p>Hello! Ask me about the data. (e.g., "Compare math scores for males and females")</p>
            </div>
        </div>
        
        <!-- Loading Indicator -->
        <div id="chat-loading" class="hidden p-4 border-t border-gray-200">
            <div class="chat-message bot">
                 <p class="bg-gray-200 text-gray-800 p-3 rounded-lg inline-block">
                    <span class="animate-pulse">...</span>
                 </p>
            </div>
        </div>

        <!-- Chat Input -->
        <form id="chat-form" class="p-4 border-t border-gray-200">
            <div class="flex items-center space-x-2">
                <input id="chat-input" type="text" placeholder="Type your question..." class="flex-1 border-gray-300 rounded-lg shadow-sm focus:border-indigo-500 focus:ring-indigo-500">
                <button type="submit" class="bg-indigo-600 text-white p-2 rounded-lg hover:bg-indigo-700 shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" style="transform: rotate(90deg);">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8" />
                    </svg>
                </button>
            </div>
        </form>
    </div>

    <!-- Chat Toggle Button -->
    <button id="chat-toggle-button" class="fixed bottom-6 right-6 bg-indigo-600 text-white p-4 rounded-full shadow-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 z-50">
        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.939L3 21l1.22-3.659A8.003 8.003 0 013 12c0-4.418 4.03-8 9-8s9 3.582 9 8z" />
        </svg>
    </button>

    <script type="module">
        // Embed the CSV data directly
        // I've included a large sample of the 1000 rows provided.
        const csvData = `gender,race/ethnicity,parental level of education,lunch,test preparation course,math score,reading score,writing score
female,group B,bachelor's degree,standard,none,72,72,74
female,group C,some college,standard,completed,69,90,88
female,group B,master's degree,standard,none,90,95,93
male,group A,associate's degree,free/reduced,none,47,57,44
male,group C,some college,standard,none,76,78,75
female,group B,associate's degree,standard,none,71,83,78
female,group B,some college,standard,completed,88,95,92
male,group B,some college,free/reduced,none,40,43,39
male,group D,high school,free/reduced,completed,64,64,67
female,group B,high school,free/reduced,none,38,60,50
male,group C,associate's degree,standard,none,58,54,52
male,group D,associate's degree,standard,none,40,52,43
female,group B,high school,standard,none,65,81,73
male,group A,some college,standard,completed,78,72,70
female,group A,master's degree,standard,none,50,53,58
female,group C,some high school,standard,none,69,75,78
male,group C,high school,standard,none,88,89,86
female,group B,some high school,free/reduced,none,18,32,28
male,group C,master's degree,free/reduced,completed,46,42,46
female,group C,associate's degree,free/reduced,none,54,58,61
male,group D,high school,standard,none,66,69,63
female,group B,some college,free/reduced,completed,65,75,70
male,group D,some college,standard,none,44,54,53
female,group C,some high school,standard,none,69,73,73
male,group D,bachelor's degree,free/reduced,completed,74,71,80
male,group A,master's degree,free/reduced,none,73,74,72
male,group B,some college,standard,none,69,54,55
female,group C,bachelor's degree,standard,none,67,69,75
male,group C,high school,standard,none,70,70,65
female,group D,master's degree,standard,none,62,70,75
female,group D,some college,standard,none,69,74,74
female,group B,some college,standard,none,63,65,61
female,group E,master's degree,free/reduced,none,56,72,65
male,group D,some college,standard,none,40,42,38
male,group E,some college,standard,none,97,87,82
male,group E,associate's degree,standard,completed,81,81,79
female,group D,associate's degree,standard,none,74,81,83
female,group D,some high school,free/reduced,none,50,64,59
female,group D,associate's degree,free/reduced,completed,75,90,88
male,group B,associate's degree,free/reduced,none,57,56,57
male,group C,associate's degree,free/reduced,none,55,61,54
female,group C,associate's degree,standard,none,58,73,68
female,group B,associate's degree,standard,none,53,58,65
male,group B,some college,free/reduced,completed,59,65,66
female,group E,associate's degree,free/reduced,none,50,56,54
male,group B,associate's degree,standard,none,65,54,57
female,group A,associate's degree,standard,completed,55,65,62
female,group C,high school,standard,none,66,71,76
female,group D,associate's degree,free/reduced,completed,57,74,76
male,group C,high school,standard,completed,82,84,82
male,group E,some college,standard,none,53,55,48
male,group E,associate's degree,free/reduced,completed,77,69,68
male,group C,some college,standard,none,53,44,42
male,group D,high school,standard,none,88,78,75
female,group C,some high school,free/reduced,completed,71,84,87
female,group C,high school,free/reduced,none,33,41,43
female,group E,associate's degree,standard,completed,82,85,86
male,group D,associate's degree,standard,none,52,55,49
male,group D,some college,standard,completed,58,59,58
female,group C,some high school,free/reduced,none,0,17,10
male,group E,bachelor's degree,free/reduced,completed,79,74,72
male,group A,some high school,free/reduced,none,39,39,34
male,group A,associate's degree,free/reduced,none,62,61,55
female,group C,associate's degree,standard,none,69,80,71
female,group D,some high school,standard,none,59,58,59
male,group B,some high school,standard,none,67,64,61
male,group D,some high school,free/reduced,none,45,37,37
female,group C,some college,standard,none,60,72,74
male,group B,associate's degree,free/reduced,none,61,58,56
female,group C,associate's degree,standard,none,39,64,57
female,group D,some college,free/reduced,completed,58,63,73
male,group D,some college,standard,completed,63,55,63
female,group A,associate's degree,free/reduced,none,41,51,48
male,group C,some high school,free/reduced,none,61,57,56
male,group C,some high school,standard,none,49,49,41
male,group B,associate's degree,free/reduced,none,44,41,38
male,group E,some high school,standard,none,30,26,22
male,group A,bachelor's degree,standard,completed,80,78,81
female,group D,some high school,standard,completed,61,74,72
female,group E,master's degree,standard,none,62,68,68
female,group B,associate's degree,standard,none,47,49,50
male,group B,high school,free/reduced,none,49,45,45
male,group A,some college,free/reduced,completed,50,47,54
male,group E,associate's degree,standard,none,72,64,63
male,group D,high school,free/reduced,none,42,39,34
female,group C,some college,standard,none,73,80,82
female,group C,some college,free/reduced,none,76,83,88
female,group D,associate's degree,standard,none,71,71,74
female,group A,some college,standard,none,58,70,67
female,group D,some high school,standard,none,73,86,82
female,group C,bachelor's degree,standard,none,65,72,74
male,group C,high school,free/reduced,none,27,34,36
male,group C,high school,standard,none,71,79,71
male,group C,associate's degree,free/reduced,completed,43,45,50
female,group B,some college,standard,none,79,86,92
male,group C,associate's degree,free/reduced,completed,78,81,82
male,group B,some high school,standard,completed,65,66,62
female,group E,some college,standard,completed,63,72,70
female,group D,some college,free/reduced,none,58,67,62
female,group D,bachelor's degree,standard,none,65,67,62
male,group B,some college,standard,none,79,67,67
male,group D,bachelor's degree,standard,completed,68,74,74
female,group D,associate's degree,standard,none,85,91,89
male,group B,high school,standard,completed,60,44,47
male,group C,some college,standard,completed,98,86,90
female,group C,some college,standard,none,58,67,72
female,group D,master's degree,standard,none,87,100,100
male,group E,associate's degree,standard,completed,66,63,64
female,group B,associate's degree,free/reduced,none,52,76,70
female,group B,some high school,standard,none,70,64,72
female,group D,associate's degree,free/reduced,completed,77,89,98
male,group C,high school,standard,none,62,55,49
male,group A,associate's degree,standard,none,54,53,47
female,group D,some college,standard,none,51,58,54
female,group E,bachelor's degree,standard,completed,99,100,100
male,group C,high school,standard,none,84,77,74
female,group B,bachelor's degree,free/reduced,none,75,85,82
female,group D,bachelor's degree,standard,none,78,82,79
female,group D,some high school,standard,none,51,63,61
female,group C,some college,standard,none,55,69,65
female,group C,bachelor's degree,standard,completed,79,92,89
male,group B,associate's degree,standard,completed,91,89,92
female,group C,some college,standard,completed,88,93,93
male,group D,high school,free/reduced,none,63,57,56
male,group E,some college,standard,none,83,80,73
female,group B,high school,standard,none,87,95,86
male,group B,some high school,standard,none,72,68,67
male,group D,some college,standard,completed,65,77,74
male,group D,master's degree,standard,none,82,82,74
female,group A,bachelor's degree,standard,none,51,49,51
male,group D,master's degree,standard,none,89,84,82
male,group C,some high school,free/reduced,completed,53,37,40
male,group E,some college,free/reduced,completed,87,74,70
female,group C,some college,standard,completed,75,81,84
male,group D,bachelor's degree,free/reduced,completed,74,79,75
male,group C,bachelor's degree,standard,none,58,55,48
male,group B,some high school,standard,completed,51,54,41
male,group E,high school,standard,none,70,55,56
female,group C,associate's degree,standard,none,59,66,67
male,group D,some college,standard,completed,71,61,69
female,group D,some high school,standard,none,76,72,71
female,group C,some college,free/reduced,none,59,62,64
female,group E,some college,free/reduced,completed,42,55,54
male,group A,high school,standard,none,57,43,47
male,group D,some college,standard,none,88,73,78
female,group C,some college,free/reduced,none,22,39,33
male,group B,some high school,standard,none,88,84,75
male,group C,associate's degree,free/reduced,none,73,68,66
female,group D,bachelor's degree,standard,completed,68,75,81
male,group E,associate's degree,free/reduced,completed,100,100,93
male,group A,some high school,standard,completed,62,67,69
male,group A,bachelor's degree,standard,none,77,67,68
female,group B,associate's degree,standard,completed,59,70,66
male,group D,bachelor's degree,standard,none,54,49,47
male,group D,some high school,standard,none,62,67,61
female,group C,some college,standard,completed,70,89,88
female,group E,high school,free/reduced,completed,66,74,78
male,group B,some college,free/reduced,none,60,60,60
female,group B,associate's degree,standard,completed,61,86,87
male,group D,associate's degree,free/reduced,none,66,62,64
male,group B,associate's degree,free/reduced,completed,82,78,74
female,group E,some college,free/reduced,completed,75,88,85
male,group B,master's degree,free/reduced,none,49,53,52
male,group C,high school,standard,none,52,53,49
female,group E,master's degree,standard,none,81,92,91
female,group C,bachelor's degree,standard,completed,96,100,100
male,group C,high school,free/reduced,completed,53,51,51
female,group B,master's degree,free/reduced,completed,58,76,78
female,group B,high school,standard,completed,68,83,78
female,group C,some college,free/reduced,completed,67,75,70
male,group A,high school,standard,completed,72,73,74
male,group E,some high school,standard,none,94,88,78
female,group D,some college,standard,none,79,86,81
female,group C,associate's degree,standard,none,63,67,70
female,group C,bachelor's degree,free/reduced,completed,43,51,54
female,group C,master's degree,standard,completed,81,91,87
female,group B,high school,free/reduced,completed,46,54,58
female,group C,associate's degree,standard,completed,71,77,77
female,group B,master's degree,free/reduced,completed,52,70,62
female,group D,some high school,standard,completed,97,100,100
male,group C,master's degree,free/reduced,completed,62,68,75
female,group C,some college,free/reduced,none,46,64,66
female,group E,high school,standard,none,50,50,47
female,group D,associate's degree,standard,none,65,69,70
male,group C,some high school,free/reduced,completed,45,52,49
male,group C,associate's degree,free/reduced,completed,65,67,65
male,group E,high school,standard,none,80,76,65
male,group D,some high school,standard,completed,62,66,68
male,group B,some high school,free/reduced,none,48,52,45
female,group C,bachelor's degree,standard,none,77,88,87
female,group E,associate's degree,standard,none,66,65,69
male,group D,some college,standard,completed,76,83,79
female,group B,some high school,standard,none,62,64,66
male,group D,some college,standard,completed,77,62,62
female,group C,master's degree,standard,completed,69,84,85
male,group D,associate's degree,standard,none,61,55,52
male,group C,some high school,free/reduced,completed,59,69,65
male,group E,high school,free/reduced,none,55,56,51
female,group B,some college,free/reduced,none,45,53,55
female,group B,bachelor's degree,free/reduced,none,78,79,76
female,group C,associate's degree,standard,completed,67,84,86
female,group D,some college,free/reduced,none,65,81,77
male,group C,associate's degree,standard,none,69,77,69
female,group B,associate's degree,standard,none,57,69,68
male,group C,some college,standard,none,59,41,42
male,group D,some high school,standard,completed,74,71,78
male,group E,bachelor's degree,standard,none,82,62,62
male,group E,high school,standard,completed,81,80,76
female,group B,some college,free/reduced,none,74,81,76
female,group B,some college,free/reduced,none,58,61,66
male,group D,some high school,free/reduced,completed,80,79,79
male,group C,some college,free/reduced,none,35,28,27
female,group C,high school,free/reduced,none,42,62,60
male,group C,associate's degree,free/reduced,completed,60,51,56
male,group E,high school,standard,completed,87,91,81
male,group B,some high school,standard,completed,84,83,75
female,group E,associate's degree,free/reduced,completed,83,86,88
female,group C,high school,free/reduced,none,34,42,39
male,group B,high school,free/reduced,none,66,77,70
male,group B,some high school,standard,completed,61,56,56
female,group D,high school,standard,completed,56,68,74
male,group B,associate's degree,standard,none,87,85,73
female,group C,some high school,free/reduced,none,55,65,62
male,group D,some high school,standard,none,86,80,75
female,group B,associate's degree,standard,completed,52,66,73
female,group E,master's degree,free/reduced,none,45,56,54
female,group C,some college,standard,none,72,72,71
male,group D,high school,standard,none,57,50,54
male,group A,some high school,free/reduced,none,68,72,64
female,group C,some college,standard,completed,88,95,94
male,group D,some college,standard,none,76,64,66
male,group C,associate's degree,standard,none,46,43,42
female,group B,bachelor's degree,standard,none,67,86,83
male,group E,some high school,standard,none,92,87,78
male,group C,bachelor's degree,standard,completed,83,82,84
male,group D,associate's degree,standard,none,80,75,77
male,group D,bachelor's degree,free/reduced,none,63,66,67
female,group D,some high school,standard,completed,64,60,74
male,group B,some college,standard,none,54,52,51
male,group C,associate's degree,standard,none,84,80,80
male,group D,high school,free/reduced,completed,73,68,66
female,group E,bachelor's degree,standard,none,80,83,83
female,group D,high school,standard,none,56,52,55
male,group E,some college,standard,none,59,51,43
male,group D,some high school,standard,none,75,74,69
male,group C,associate's degree,standard,none,85,76,71
male,group E,associate's degree,standard,none,89,76,74
female,group B,high school,standard,completed,58,70,68
female,group B,high school,standard,none,65,64,62
male,group C,high school,standard,none,68,60,53
male,group A,some high school,standard,completed,47,49,49
female,group D,some college,free/reduced,none,71,83,83
female,group B,some high school,standard,completed,60,70,70
male,group D,master's degree,standard,none,80,80,72
male,group D,high school,standard,none,54,52,52
female,group E,some college,standard,none,62,73,70
female,group C,associate's degree,free/reduced,none,64,73,68
male,group C,associate's degree,standard,completed,78,77,77
female,group B,some college,standard,none,70,75,78
female,group C,master's degree,free/reduced,completed,65,81,81
female,group C,some high school,free/reduced,completed,64,79,77
male,group C,some college,standard,completed,79,79,78
female,group C,some high school,free/reduced,none,44,50,51
female,group E,high school,standard,none,99,93,90
male,group D,high school,standard,none,76,73,68
male,group D,some high school,free/reduced,none,59,42,41
female,group C,bachelor's degree,standard,none,63,75,81
female,group D,high school,standard,none,69,72,77
female,group D,associate's degree,standard,completed,88,92,95
female,group E,some college,free/reduced,none,71,76,70
male,group C,bachelor's degree,standard,none,69,63,61
male,group C,some college,standard,none,58,49,42
female,group D,associate's degree,free/reduced,none,47,53,58
female,group D,some college,standard,none,65,70,71
male,group B,some college,standard,completed,88,85,76
male,group C,bachelor's degree,standard,none,83,78,73
female,group C,some high school,standard,completed,85,92,93
female,group E,high school,standard,completed,59,63,75
female,group C,some high school,free/reduced,none,65,86,80
male,group B,bachelor's degree,free/reduced,none,73,56,57
male,group D,high school,standard,none,53,52,42
male,group D,high school,standard,none,45,48,46
female,group D,bachelor's degree,free/reduced,none,73,79,84
female,group D,some college,free/reduced,completed,70,78,78
female,group B,some high school,standard,none,37,46,46
male,group B,associate's degree,standard,completed,81,82,82
male,group E,associate's degree,standard,completed,97,82,88
female,group B,some high school,standard,none,67,89,82
male,group B,bachelor's degree,free/reduced,none,88,75,76
male,group E,some high school,standard,completed,77,76,77
male,group C,associate's degree,standard,none,76,70,68
male,group D,some high school,standard,none,86,73,70
male,group C,some high school,standard,completed,63,60,57
female,group E,bachelor's degree,standard,none,65,73,75
male,group D,high school,free/reduced,completed,78,77,80
male,group B,associate's degree,free/reduced,none,67,62,60
male,group A,some high school,standard,completed,46,41,43
male,group E,associate's degree,standard,completed,71,74,68
male,group C,high school,free/reduced,completed,40,46,50
male,group D,associate's degree,free/reduced,none,90,87,75
male,group A,some college,free/reduced,completed,81,78,81
male,group D,some high school,free/reduced,none,56,54,52
female,group C,associate's degree,standard,completed,67,84,81
male,group B,associate's degree,standard,none,80,76,64
female,group C,associate's degree,standard,completed,74,75,83
female,group C,some high school,standard,none,74,75,82
male,group A,high school,standard,none,57,51,54
female,group C,associate's degree,standard,none,40,59,51
male,group E,some high school,standard,completed,81,75,76
female,group A,some high school,free/reduced,none,44,45,45
female,group D,some college,free/reduced,completed,67,86,83
female,group B,some high school,standard,completed,65,82,78
female,group D,associate's degree,free/reduced,none,55,76,76
female,group D,bachelor's degree,free/reduced,none,62,72,74
male,group A,high school,standard,none,63,63,62
female,group E,master's degree,standard,completed,88,99,95
male,group C,high school,free/reduced,none,62,55,55
female,group C,high school,free/reduced,completed,59,71,65
female,group D,some college,standard,completed,68,78,77
female,group D,some college,free/reduced,none,77,86,86
`;

        // --- Global Variables ---
        let originalData = [];
        let filteredData = [];
        const scoreColors = {
            "math score": "#4f46e5", // indigo-600
            "reading score": "#16a34a", // green-600
            "writing score": "#db2777" // pink-600
        };

        // --- D3 Chart Setup ---
        const d3Tooltip = d3.select("#tooltip");

        // Histogram setup
        const histMargin = { top: 20, right: 30, bottom: 40, left: 40 };
        const histSvg = d3.select("#histogram-chart").append("svg")
            .attr("width", "100%")
            .attr("height", "100%");
        const histChart = histSvg.append("g");
        const histX = d3.scaleLinear().domain([0, 100]);
        const histXAxis = histSvg.append("g")
            .attr("class", "axis");
        const histY = d3.scaleLinear();
        const histYAxis = histSvg.append("g")
            .attr("class", "axis");
        const histGrid = histSvg.append("g")
            .attr("class", "grid");

        // Scatter plot setup
        const scatterMargin = { top: 20, right: 30, bottom: 40, left: 40 };
        const scatterSvg = d3.select("#scatter-plot").append("svg")
            .attr("width", "100%")
            .attr("height", "100%");
        const scatterChart = scatterSvg.append("g");
        const scatterX = d3.scaleLinear().domain([0, 100]);
        const scatterXAxis = scatterSvg.append("g")
            .attr("class", "axis");
        const scatterY = d3.scaleLinear().domain([0, 100]);
        const scatterYAxis = scatterSvg.append("g")
            .attr("class", "axis");
        const scatterGrid = scatterSvg.append("g")
            .attr("class", "grid");

        // --- Chatbot Variables ---
        let chatHistory = [];
        const chatWidget = d3.select("#chat-widget");
        const chatToggleButton = d3.select("#chat-toggle-button");
        const closeChatButton = d3.select("#close-chat");
        const chatMessages = d3.select("#chat-messages");
        const chatForm = d3.select("#chat-form");
        const chatInput = d3.select("#chat-input");
        const chatLoading = d3.select("#chat-loading");

        // --- Helper Functions ---
        
        /**
         * Get unique values from an array of objects for a specific key
         */
        function getUniqueValues(data, key) {
            return [...new Set(data.map(d => d[key]))].sort();
        }

        /**
         * Create filter UI components
         */
        function createFilters() {
            const filtersContainer = d3.select("#filters-container");
            const filterCategories = [
                { id: "gender", label: "Gender", key: "gender" },
                { id: "race", label: "Race/Ethnicity", key: "race/ethnicity" },
                { id: "education", label: "Parental Education", key: "parental level of education" },
                { id: "lunch", label: "Lunch", key: "lunch" },
                { id: "prep", label: "Test Prep Course", key: "test preparation course" }
            ];

            filterCategories.forEach(cat => {
                const values = getUniqueValues(originalData, cat.key);
                
                const section = filtersContainer.append("div")
                    .attr("id", `filter-${cat.id}`);
                
                section.append("h4")
                    .attr("class", "text-md font-semibold mb-2")
                    .text(cat.label);
                
                const fieldset = section.append("fieldset")
                    .attr("class", "space-y-2");
                
                // "All" option
                fieldset.append("div")
                    .attr("class", "flex items-center")
                    .html(`
                        <input id="${cat.id}-all" name="${cat.id}" type="checkbox" value="all" checked class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 filter-checkbox">
                        <label for="${cat.id}-all" class="ml-3 block text-sm text-gray-700">All</label>
                    `);

                // Other options
                values.forEach(val => {
                    fieldset.append("div")
                        .attr("class", "flex items-center")
                        .html(`
                            <input id="${cat.id}-${val.replace(/ /g, '-')}" name="${cat.id}" type="checkbox" value="${val}" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500 filter-checkbox">
                            <label for="${cat.id}-${val.replace(/ /g, '-')}" class="ml-3 block text-sm text-gray-700">${val}</label>
                        `);
                });
            });

            // Add event listeners to filters
            d3.selectAll(".filter-checkbox").on("change", function() {
                const groupName = d3.select(this).attr("name");
                const allCheckbox = d3.select(`#${groupName}-all`);

                if (d3.select(this).attr("value") === "all") {
                    // If "All" is checked, uncheck all others
                    if (d3.select(this).property("checked")) {
                        d3.selectAll(`input[name="${groupName}"]:not([value="all"])`).property("checked", false);
                    }
                } else {
                    // If another box is checked, uncheck "All"
                    if (d3.select(this).property("checked")) {
                        allCheckbox.property("checked", false);
                    }
                }
                
                // If no individual boxes are checked, check "All"
                const checkedBoxes = d3.selectAll(`input[name="${groupName}"]:not([value="all"]):checked`).nodes();
                if (checkedBoxes.length === 0) {
                    allCheckbox.property("checked", true);
                }

                updateDashboard();
            });
        }

        /**
         * Get current filter state
         */
        function getFilterState() {
            const filters = {};
            const filterCategories = ["gender", "race", "education", "lunch", "prep"];
            const filterKeys = ["gender", "race/ethnicity", "parental level of education", "lunch", "test preparation course"];

            filterCategories.forEach((catId, i) => {
                const key = filterKeys[i];
                if (!d3.select(`#${catId}-all`).property("checked")) {
                    const checkedNodes = d3.selectAll(`input[name="${catId}"]:not([value="all"]):checked`).nodes();
                    filters[key] = checkedNodes.map(node => node.value);
                }
            });
            return filters;
        }

        /**
         * Main function to update all dashboard components
         */
        function updateDashboard() {
            const filters = getFilterState();
            
            // Filter data
            filteredData = originalData.filter(d => {
                return Object.keys(filters).every(key => {
                    return filters[key].includes(d[key]);
                });
            });

            // Update KPIs
            updateKPIs(filteredData);

            // Update Charts
            updateHistogram(filteredData);
            updateScatterPlot(filteredData);

            // Update Table
            updateTable(filteredData);
        }

        /**
         * Update KPI cards
         */
        function updateKPIs(data) {
            const avgMath = d3.mean(data, d => d["math score"]) || 0;
            const avgReading = d3.mean(data, d => d["reading score"]) || 0;
            const avgWriting = d3.mean(data, d => d["writing score"]) || 0;

            d3.select("#avg-math").text(avgMath.toFixed(1));
            d3.select("#avg-reading").text(avgReading.toFixed(1));
            d3.select("#avg-writing").text(avgWriting.toFixed(1));
        }

        /**
         * Update Histogram
         */
        function updateHistogram(data) {
            const scoreType = d3.select("#histogram-score").property("value");
            const color = scoreColors[scoreType];

            // Get dimensions
            const parent = d3.select("#histogram-chart").node().getBoundingClientRect();
            const width = parent.width;
            const height = parent.height;
            const innerWidth = width - histMargin.left - histMargin.right;
            const innerHeight = height - histMargin.top - histMargin.bottom;

            // Update SVG size
            histSvg.attr("width", width).attr("height", height);
            histChart.attr("transform", `translate(${histMargin.left},${histMargin.top})`);
            
            // Update X axis
            histX.range([0, innerWidth]);
            histXAxis.attr("transform", `translate(${histMargin.left},${histMargin.top + innerHeight})`)
                .call(d3.axisBottom(histX))
                .selectAll("text")
                .attr("class", "axis-label");
            histSvg.selectAll(".x-label").data([0]).join("text")
                .attr("class", "x-label axis-label")
                .attr("text-anchor", "middle")
                .attr("x", histMargin.left + innerWidth / 2)
                .attr("y", height - 5)
                .text("Score");

            // Prepare bins
            const histogram = d3.bin()
                .value(d => d[scoreType])
                .domain(histX.domain())
                .thresholds(histX.ticks(20)); // 20 bins
            
            const bins = histogram(data);

            // Update Y axis
            histY.domain([0, d3.max(bins, d => d.length)]).range([innerHeight, 0]);
            histYAxis.attr("transform", `translate(${histMargin.left},${histMargin.top})`)
                .call(d3.axisLeft(histY).ticks(5))
                .selectAll("text")
                .attr("class", "axis-label");
            histSvg.selectAll(".y-label").data([0]).join("text")
                .attr("class", "y-label axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", `translate(15, ${histMargin.top + innerHeight / 2}) rotate(-90)`)
                .text("Frequency");

            // Add grid
            histGrid.attr("transform", `translate(${histMargin.left},${histMargin.top})`)
                .call(d3.axisLeft(histY).ticks(5).tickSize(-innerWidth).tickFormat(""));

            // Draw bars
            histChart.selectAll("rect")
                .data(bins)
                .join(
                    enter => enter.append("rect")
                        .attr("x", d => histX(d.x0) + 1)
                        .attr("width", d => Math.max(0, histX(d.x1) - histX(d.x0) - 1))
                        .attr("y", d => histY(d.length))
                        .attr("height", d => innerHeight - histY(d.length))
                        .attr("fill", color)
                        .attr("opacity", 0.8),
                    update => update
                        .attr("x", d => histX(d.x0) + 1)
                        .attr("width", d => Math.max(0, histX(d.x1) - histX(d.x0) - 1))
                        .attr("y", d => histY(d.length))
                        .attr("height", d => innerHeight - histY(d.length)),
                    exit => exit.remove()
                )
                .on("mouseover", (event, d) => {
                    d3Tooltip.transition().duration(200).style("opacity", .9);
                    d3Tooltip.html(`Range: ${d.x0}-${d.x1}<br>Count: ${d.length}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    d3Tooltip.transition().duration(500).style("opacity", 0);
                });
        }

        /**
         * Update Scatter Plot
         */
        function updateScatterPlot(data) {
            const xVal = d3.select("#scatter-x").property("value");
            const yVal = d3.select("#scatter-y").property("value");

            // Get dimensions
            const parent = d3.select("#scatter-plot").node().getBoundingClientRect();
            const width = parent.width;
            const height = parent.height;
            const innerWidth = width - scatterMargin.left - scatterMargin.right;
            const innerHeight = height - scatterMargin.top - scatterMargin.bottom;

            // Update SVG size
            scatterSvg.attr("width", width).attr("height", height);
            scatterChart.attr("transform", `translate(${scatterMargin.left},${scatterMargin.top})`);
            
            // Update X axis
            scatterX.range([0, innerWidth]);
            scatterXAxis.attr("transform", `translate(${scatterMargin.left},${scatterMargin.top + innerHeight})`)
                .call(d3.axisBottom(scatterX))
                .selectAll("text")
                .attr("class", "axis-label");
            scatterSvg.selectAll(".x-label").data([0]).join("text")
                .attr("class", "x-label axis-label")
                .attr("text-anchor", "middle")
                .attr("x", scatterMargin.left + innerWidth / 2)
                .attr("y", height - 5)
                .text(xVal);

            // Update Y axis
            scatterY.range([innerHeight, 0]);
            scatterYAxis.attr("transform", `translate(${scatterMargin.left},${scatterMargin.top})`)
                .call(d3.axisLeft(scatterY))
                .selectAll("text")
                .attr("class", "axis-label");
            scatterSvg.selectAll(".y-label").data([0]).join("text")
                .attr("class", "y-label axis-label")
                .attr("text-anchor", "middle")
                .attr("transform", `translate(15, ${scatterMargin.top + innerHeight / 2}) rotate(-90)`)
                .text(yVal);
            
            // Add grid
            scatterGrid.attr("transform", `translate(${scatterMargin.left},${scatterMargin.top})`)
                .call(d3.axisLeft(scatterY).ticks(10).tickSize(-innerWidth).tickFormat(""));

            // Draw points
            scatterChart.selectAll("circle")
                .data(data)
                .join("circle")
                    .attr("cx", d => scatterX(d[xVal]))
                    .attr("cy", d => scatterY(d[yVal]))
                    .attr("r", 3)
                    .attr("fill", "#2563eb") // blue-600
                    .attr("opacity", 0.5)
                .on("mouseover", (event, d) => {
                    d3Tooltip.transition().duration(200).style("opacity", .9);
                    d3Tooltip.html(`${xVal}: ${d[xVal]}<br>${yVal}: ${d[yVal]}`)
                        .style("left", (event.pageX + 10) + "px")
                        .style("top", (event.pageY - 28) + "px");
                })
                .on("mouseout", () => {
                    d3Tooltip.transition().duration(500).style("opacity", 0);
                });
        }

        /**
         * Update Data Table
         */
        function updateTable(data) {
            d3.select("#table-count").text(data.length);
            
            const tableBody = d3.select("#data-table");
            tableBody.html(""); // Clear existing rows

            // Add new rows (up to 100 for performance)
            const rows = tableBody.selectAll("tr")
                .data(data.slice(0, 100))
                .enter()
                .append("tr")
                .attr("class", "even:bg-gray-50");

            const columns = ["gender", "race/ethnicity", "parental level of education", "lunch", "test preparation course", "math score", "reading score", "writing score"];
            
            rows.selectAll("td")
                .data(d => columns.map(col => d[col]))
                .enter()
                .append("td")
                .attr("class", "px-6 py-4 whitespace-nowrap text-sm text-gray-700")
                .text(d => d);
        }

        // --- Chatbot Functions ---

        /**
         * Exponential backoff for API calls
         */
        async function fetchWithBackoff(url, options, retries = 5, delay = 1000) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) {
                    if (response.status === 429 && retries > 0) {
                        // Throttled, retry with backoff
                        // console.log("Retrying request...");
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return fetchWithBackoff(url, options, retries - 1, delay * 2);
                    }
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            } catch (error) {
                if (retries > 0) {
                    // console.log("Retrying request...");
                    await new Promise(resolve => setTimeout(resolve, delay));
                    return fetchWithBackoff(url, options, retries - 1, delay * 2);
                }
                console.error("Fetch failed after multiple retries:", error);
                throw error;
            }
        }

        /**
         * Display a message in the chat window
         */
        function displayMessage(text, sender) {
            chatLoading.classed("hidden", true); // Hide loading
            
            const messageDiv = chatMessages.append("div")
                .attr("class", `chat-message ${sender}`);
            
            messageDiv.append("p").text(text);
            
            // Scroll to bottom
            chatMessages.node().scrollTop = chatMessages.node().scrollHeight;
        }

        /**
         * Get response from Gemini API
         */
        async function getBotResponse(userQuery) {
            chatLoading.classed("hidden", false); // Show loading
            
            // Create data context
            const fullDatasetSummary = `The total dataset has ${originalData.length} students.`;
            const filteredDatasetSummary = `The user's current filter has selected ${filteredData.length} students. The averages for this selection are: Math (${d3.mean(filteredData, d => d["math score"]).toFixed(1)}), Reading (${d3.mean(filteredData, d => d["reading score"]).toFixed(1)}), Writing (${d3.mean(filteredData, d => d["writing score"]).toFixed(1)}).`;
            
            const finalPrompt = `${fullDatasetSummary}\n${filteredDatasetSummary}\n\nUser Question: ${userQuery}\n\nAnswer based *only* on this context. Be concise.`;
            
            // Add user message to history
            chatHistory.push({ role: "user", parts: [{ text: finalPrompt }] });

            const apiKey = ""; // API key is handled by the environment
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

            const payload = {
                contents: chatHistory,
                // systemInstruction is part of the history now
            };

            try {
                const result = await fetchWithBackoff(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (result.candidates && result.candidates.length > 0 && result.candidates[0].content && result.candidates[0].content.parts) {
                    const botText = result.candidates[0].content.parts[0].text;
                    displayMessage(botText, 'bot');
                    // Add bot response to history
                    chatHistory.push({ role: "model", parts: [{ text: botText }] });
                } else {
                    displayMessage("Sorry, I couldn't get a response. Please try again.", 'bot');
                    // Remove user query from history if bot fails
                    chatHistory.pop();
                }
            } catch (error) {
                console.error("Error calling Gemini API:", error);
                displayMessage("Sorry, something went wrong. Please check the console.", 'bot');
                 // Remove user query from history if bot fails
                chatHistory.pop();
            } finally {
                chatLoading.classed("hidden", true); // Hide loading
            }
        }

        // --- Initialization ---
        function initialize() {
            // Parse CSV data
            originalData = d3.csvParse(csvData, (d) => {
                // Convert scores to numbers
                d["math score"] = +d["math score"];
                d["reading score"] = +d["reading score"];
                d["writing score"] = +d["writing score"];
                return d;
            });
            
            filteredData = originalData;

            // Define chat history
            chatHistory = [
                {
                    role: "user",
                    parts: [{ text: "You are a helpful data assistant. You answer questions about a student performance dataset. The dataset columns are: gender, race/ethnicity, parental level of education, lunch, test preparation course, math score, reading score, writing score. Scores range from 0 to 100. Be concise and helpful." }]
                },
                {
                    role: "model",
                    parts: [{ text: "I understand. I am ready to answer questions about the student performance data." }]
                }
            ];

            // Create filters in the sidebar
            createFilters();

            // Add event listeners for chart selectors
            d3.select("#histogram-score").on("change", () => updateHistogram(filteredData));
            d3.select("#scatter-x").on("change", () => updateScatterPlot(filteredData));
            d3.select("#scatter-y").on("change", () => updateScatterPlot(filteredData));
            
            // Chat event listeners
            chatToggleButton.on("click", () => {
                chatWidget.classed("hidden", !chatWidget.classed("hidden"));
                chatWidget.classed("flex", !chatWidget.classed("flex"));
            });

            closeChatButton.on("click", () => {
                chatWidget.classed("hidden", true);
                chatWidget.classed("flex", false);
            });

            chatForm.on("submit", (event) => {
                event.preventDefault();
                const userQuery = chatInput.property("value").trim();
                if (!userQuery) return;

                displayMessage(userQuery, 'user');
                chatInput.property("value", ""); // Clear input
                getBotResponse(userQuery);
            });

            // Initial dashboard render
            updateDashboard();

            // Re-draw on window resize
            window.addEventListener('resize', () => {
                updateHistogram(filteredData);
                updateScatterPlot(filteredData);
            });
        }

        // Run initialization
        initialize();

    </script>
</body>
</html>
